<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>Emotion-Based Playlist</title>
    <script>
        async function startCamera() {
            // Show video container
            document.getElementById('video-container').style.display = 'block';
            document.getElementById('video-feed').src = "/video_feed?" + new Date().getTime(); // Ensures fresh feed
            document.getElementById('detected-emotion').innerText = "Detecting emotion...";
            document.getElementById('playlist-link').innerHTML = "";  // Clear previous link

            // Wait for video processing
            await new Promise(resolve => setTimeout(resolve, 6000));  

            try {
                // Fetch detected emotion
                const emotionResponse = await fetch('/detect_emotion');
                const emotionData = await emotionResponse.json();
                const detectedEmotion = emotionData.emotion || "neutral";
                document.getElementById('detected-emotion').innerText = "Detected Emotion: " + detectedEmotion;

                // Show the input form to ask for the number of songs
                document.getElementById('song-count-form').style.display = 'block';
                document.getElementById('submit-button').onclick = function() {
                    const numSongs = document.getElementById('num-songs').value;
                    generatePlaylist(detectedEmotion, numSongs);
                };
            } catch (error) {
                document.getElementById('detected-emotion').innerText = "Error detecting emotion.";
                document.getElementById('playlist-link').innerText = "Error fetching playlist.";
            }
        }

        async function generatePlaylist(emotion, numSongs) {
            try {
                const response = await fetch('/generate_playlist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `emotion=${emotion}&num_songs=${numSongs}`
                });
                const data = await response.json();
                if (data.playlist_url) {
                    document.getElementById('playlist-link').innerHTML = `<a href="${data.playlist_url}" target="_blank">View Playlist</a>`;
                } else {
                    document.getElementById('playlist-link').innerText = "No playlist found for this mood.";
                }
            } catch (error) {
                document.getElementById('playlist-link').innerText = "Error generating playlist.";
            }
        }
    </script>
</head>
<body>
    <h1>MoodSync AI</h1>
    <h2>Emotion-Based Spotify Playlist Generator</h2>
    <button onclick="startCamera()">Get Playlist</button>

    <div id="video-container" style="display:none;">
        <img id="video-feed" src="" width="640" height="480">
    </div>

    <h2 id="detected-emotion"></h2>

    <div id="song-count-form" style="display:none;">
        <label for="num-songs">How many songs do you want in your playlist?</label>
        <input type="number" id="num-songs" name="num-songs" min="1" max="50" value="10">
        <button id="submit-button">Generate Playlist</button>
    </div>

    <p id="playlist-link"></p>  <!-- This is where the playlist link will be shown -->
</body>
</html>
